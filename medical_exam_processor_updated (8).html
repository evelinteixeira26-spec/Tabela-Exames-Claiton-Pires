<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processamento de Exames MÃ©dicos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(30, 60, 114, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
            min-height: 600px;
        }

        .pdf-upload-section {
            padding: 40px;
            background: linear-gradient(135deg, #f8fbff 0%, #ebf4ff 100%);
            border-bottom: 3px solid #e2e8f0;
        }

        .upload-area {
            background: white;
            border: 3px dashed #1e3c72;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            transition: all 0.4s ease;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(30, 60, 114, 0.1);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #2a5298;
            background: linear-gradient(135deg, #f8fbff 0%, #ebf4ff 100%);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(30, 60, 114, 0.2);
        }

        .upload-icon {
            font-size: 5rem;
            margin-bottom: 25px;
            color: #1e3c72;
        }

        .upload-area p {
            font-size: 1.3rem;
            color: #1e3c72;
            margin-bottom: 25px;
            font-weight: 500;
        }

        .pdf-list {
            margin-top: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(30, 60, 114, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .pdf-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 2px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .pdf-item:last-child {
            border-bottom: none;
        }

        .pdf-item:hover {
            background: #f8fafc;
        }

        .pdf-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .pdf-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            color: #1e3c72;
        }

        .pdf-details {
            flex: 1;
        }

        .pdf-name {
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .pdf-size {
            font-size: 0.9rem;
            color: #64748b;
        }

        .pdf-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-right: 15px;
        }

        .pdf-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .pdf-status.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .pdf-status.completed {
            background: #dcfce7;
            color: #166534;
        }

        .pdf-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .remove-pdf {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .remove-pdf:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .progress-area {
            margin-top: 25px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(30, 60, 114, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 15px;
        }

        .pdf-counter {
            background: #1e3c72;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 15px;
            display: inline-block;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(30, 60, 114, 0.3);
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(30, 60, 114, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .input-section {
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            max-height: 800px;
            display: none;
        }

        .result-section {
            padding: 30px;
            background: white;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(30, 60, 114, 0.1);
            border: 2px solid #2c3e50;
        }

        .summary-table th {
            background: #2c3e50;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            border: 1px solid #34495e;
        }

        .summary-table td {
            padding: 8px;
            border: 1px solid #bdc3c7;
            text-align: center;
            font-weight: 500;
            font-size: 0.85rem;
            min-height: 35px;
            vertical-align: middle;
        }

        .exam-header {
            background: #34495e !important;
            color: white !important;
            font-weight: bold;
            text-align: left !important;
            padding: 10px 15px !important;
        }

        .exam-date {
            background: #34495e !important;
            color: white !important;
            font-weight: bold;
            text-align: center !important;
            padding: 8px !important;
            font-size: 0.8rem;
        }

        .patient-name-header {
            background: #2c3e50 !important;
            color: white !important;
            font-weight: bold;
            text-align: center !important;
            padding: 15px !important;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        .status-normal {
            background: #d5f4e6 !important;
            color: #27ae60;
            font-weight: 600;
        }

        .status-high {
            background: #fadbd8 !important;
            color: #c0392b;
            font-weight: 600;
        }

        .status-low {
            background: #fcf3cf !important;
            color: #d4ac0d;
            font-weight: 600;
        }

        .status-positive {
            background: #fadbd8 !important;
            color: #c0392b;
            font-weight: 600;
        }

        .status-negative {
            background: #d5f4e6 !important;
            color: #27ae60;
            font-weight: 600;
        }

        .empty-cell {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 60, 114, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(30, 60, 114, 0.4);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h3 {
            margin-bottom: 25px;
            color: #1e3c72;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-content input, .modal-content select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 12px 0;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .modal-content input:focus, .modal-content select:focus {
            outline: none;
            border-color: #1e3c72;
            background: white;
            box-shadow: 0 0 0 4px rgba(30, 60, 114, 0.1);
        }

        .modal-buttons {
            margin-top: 30px;
            text-align: center;
        }

        .edit-form {
            text-align: left;
            margin: 25px 0;
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1e3c72;
        }

        .buttons {
            text-align: center;
            margin: 30px 0;
        }

        .add-result-btn {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 25px auto;
            display: block;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        }

        .add-result-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(5, 150, 105, 0.4);
        }

        .manual-toggle {
            text-align: center;
            margin: 20px 0;
        }

        .toggle-btn {
            background: linear-gradient(135deg, #fd746c 0%, #ff9068 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253, 116, 108, 0.3);
        }

        .clear-all-section {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 30%);
            padding: 20px;
            text-align: center;
            border-top: 3px solid #ef4444;
        }

        .clear-all-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
            text-transform: uppercase;
        }

        .clear-all-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(220, 38, 38, 0.5);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .pdf-upload-section {
                padding: 20px;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .upload-icon {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Processamento de Exames MÃ©dicos</h1>
            <p>AnÃ¡lise automatizada com valores de referÃªncia - Upload de atÃ© 5 PDFs ou inserÃ§Ã£o manual</p>
        </div>

        <div class="main-content">
            <!-- SeÃ§Ã£o de Upload de PDF -->
            <div class="pdf-upload-section">
                <h2 class="section-title">Upload de PDFs de Exames (atÃ© 5 arquivos)</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <div class="upload-icon">ð</div>
                        <p>Arraste atÃ© 5 PDFs de exames aqui ou clique para selecionar</p>
                        <input type="file" id="pdfFile" accept=".pdf" multiple style="display: none;">
                        <button type="button" class="btn" onclick="document.getElementById('pdfFile').click()">
                            Selecionar PDFs
                        </button>
                    </div>
                </div>
                
                <div class="pdf-counter" id="pdfCounter" style="display: none;">
                    PDFs Carregados: <span id="pdfCount">0</span>/5
                </div>

                <div class="pdf-list" id="pdfList" style="display: none;">
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn" id="processAllBtn" onclick="processAllPDFs()" style="display: none;">
                        Processar Todos os PDFs
                    </button>
                    <button type="button" class="btn btn-secondary" id="clearPdfsBtn" onclick="clearAllPDFs()" style="display: none;">
                        Limpar Lista
                    </button>
                </div>

                <div class="progress-area" id="progressArea" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">Processando PDFs...</p>
                </div>
            </div>

            <div class="manual-toggle">
                <button type="button" class="toggle-btn" onclick="toggleManualInput()">
                    InserÃ§Ã£o Manual de Exames
                </button>
            </div>

            <!-- SeÃ§Ã£o de Dados do Paciente -->
            <div class="patient-data-section" style="padding: 30px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-bottom: 3px solid #e2e8f0;">
                <h2 class="section-title">Dados do Paciente</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label for="patientName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e3c72;">Nome Completo do Paciente:</label>
                        <input type="text" id="patientName" placeholder="Nome completo do paciente" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div>
                        <label for="examDate" style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e3c72;">Data do Exame:</label>
                        <input type="date" id="examDate" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div>
                        <label for="laboratory" style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e3c72;">LaboratÃ³rio:</label>
                        <input type="text" id="laboratory" placeholder="Nome do laboratÃ³rio" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                    </div>
                </div>
                <div style="text-align: center;">
                    <button type="button" class="btn" onclick="savePatientData()" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                        Salvar Dados do Paciente
                    </button>
                </div>
            </div>

            <div class="input-section">
                <h2 class="section-title">Inserir Exames Manualmente</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <label for="examNameInput">Nome do Exame:</label>
                    <input type="text" id="examNameInput" placeholder="Ex: Hemoglobina">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <label for="examValueInput">Valor:</label>
                    <input type="text" id="examValueInput" placeholder="Ex: 14.5 g/dL">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <label for="examReferenceInput">ReferÃªncia:</label>
                    <input type="text" id="examReferenceInput" placeholder="Ex: 12-18 g/dL">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <label for="examDateInput">Data do Exame:</label>
                    <input type="date" id="examDateInput">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <label for="examStatusInput">Status:</label>
                    <select id="examStatusInput">
                        <option value="normal">Normal</option>
                        <option value="high">Alto</option>
                        <option value="low">Baixo</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                    </select>
                </div>

                <div class="buttons">
                    <button type="button" class="btn" onclick="addManualExam()">Adicionar Exame</button>
                    <button type="button" class="btn btn-secondary" onclick="clearManualForm()">Limpar FormulÃ¡rio</button>
                </div>
            </div>

            <div class="result-section">
                <h2 class="section-title">Resultado da AnÃ¡lise</h2>
                <div id="summaryResult">
                    <p style="text-align: center; color: #666; margin-top: 50px;">
                        Adicione PDFs ou preencha os dados dos exames manualmente e clique em "Processar" para ver o resultado.
                    </p>
                </div>
            </div>
        </div>

        <div class="buttons">
            <button type="button" class="btn" onclick="processExams()">Processar Exames</button>
            <button type="button" class="btn btn-secondary" onclick="downloadAsImage()" id="downloadBtn">Baixar como Imagem</button>
            <button type="button" class="btn" onclick="showEditMode()" id="editModeBtn">Modo EdiÃ§Ã£o</button>
        </div>

        <!-- SeÃ§Ã£o de Limpeza Completa -->
        <div class="clear-all-section">
            <h3 style="color: #dc2626; margin-bottom: 15px; font-size: 1.3rem;">ðï¸ Ãrea de Limpeza</h3>
            <p style="margin-bottom: 20px; color: #7f1d1d; font-weight: 500;">
                Apagar todos os dados, resumos e resetar o sistema completamente
            </p>
            <button type="button" class="clear-all-btn" onclick="confirmClearAll()">
                Limpar Tudo e Resetar
            </button>
        </div>
    </div>

    <!-- Modal de Senha -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3>Acesso ao Modo EdiÃ§Ã£o</h3>
            <p>Digite a senha para acessar o modo de ediÃ§Ã£o:</p>
            <input type="password" id="passwordInput" placeholder="Senha">
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="checkPassword()">Confirmar</button>
                <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de EdiÃ§Ã£o -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3 id="editModalTitle">Editar Resultado</h3>
            <div class="edit-form">
                <div class="form-row">
                    <label for="editExamName">Nome do Exame:</label>
                    <input type="text" id="editExamName">
                </div>
                <div class="form-row">
                    <label for="editValue">Valor:</label>
                    <input type="text" id="editValue">
                </div>
                <div class="form-row">
                    <label for="editReference">ReferÃªncia:</label>
                    <input type="text" id="editReference">
                </div>
                <div class="form-row">
                    <label for="editExamDate">Data do Exame:</label>
                    <input type="date" id="editExamDate">
                </div>
                <div class="form-row">
                    <label for="editStatus">Status:</label>
                    <select id="editStatus">
                        <option value="normal">Normal</option>
                        <option value="high">Alto</option>
                        <option value="low">Baixo</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="saveEdit()">Salvar</button>
                <button type="button" class="btn btn-danger" onclick="deleteResult()">Excluir</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de ConfirmaÃ§Ã£o para Limpeza -->
    <div class="modal" id="confirmClearModal">
        <div class="modal-content">
            <h3 style="color: #dc2626;">â ï¸ Confirmar Limpeza Completa</h3>
            <p style="margin: 20px 0; color: #7f1d1d; font-weight: 500;">
                Esta aÃ§Ã£o irÃ¡ apagar permanentemente:
            </p>
            <ul style="text-align: left; margin: 15px 0; color: #7f1d1d;">
                <li>â¢ Todos os PDFs carregados</li>
                <li>â¢ Todos os exames processados</li>
                <li>â¢ Todos os resumos gerados</li>
                <li>â¢ Dados do paciente</li>
                <li>â¢ ConfiguraÃ§Ãµes de ediÃ§Ã£o</li>
                <li>â¢ Progresso do upload</li>
            </ul>
            <p style="margin: 20px 0; color: #dc2626; font-weight: 700;">
                Esta aÃ§Ã£o NÃO PODE SER DESFEITA!
            </p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="executeCompleteReset()">
                    Sim, Limpar Tudo
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeClearModal()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // VariÃ¡veis globais
        let editMode = false;
        let currentResults = [];
        let editingIndex = -1;
        let uploadedPDFs = [];
        const MAX_PDFS = 5;

        // Configurar upload de PDF
        const uploadArea = document.getElementById('uploadArea');
        const pdfFile = document.getElementById('pdfFile');
        const progressArea = document.getElementById('progressArea');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const pdfList = document.getElementById('pdfList');
        const pdfCounter = document.getElementById('pdfCounter');
        const pdfCount = document.getElementById('pdfCount');
        const processAllBtn = document.getElementById('processAllBtn');
        const clearPdfsBtn = document.getElementById('clearPdfsBtn');

        // Drag & Drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleMultiplePDFs(files);
        });

        pdfFile.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleMultiplePDFs(files);
        });

        function handleMultiplePDFs(files) {
            const pdfFiles = files.filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length === 0) {
                alert('Por favor, selecione apenas arquivos PDF!');
                return;
            }

            const totalPDFs = uploadedPDFs.length + pdfFiles.length;
            if (totalPDFs > MAX_PDFS) {
                alert(`VocÃª pode carregar no mÃ¡ximo ${MAX_PDFS} PDFs. Atualmente hÃ¡ ${uploadedPDFs.length} PDFs carregados.`);
                return;
            }

            pdfFiles.forEach((file, index) => {
                if (uploadedPDFs.length < MAX_PDFS) {
                    const pdfId = Date.now() + index;
                    uploadedPDFs.push({
                        id: pdfId,
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size),
                        status: 'pending'
                    });
                }
            });

            updatePDFList();
            pdfFile.value = ''; // Limpar input
        }

        function updatePDFList() {
            if (uploadedPDFs.length === 0) {
                pdfList.style.display = 'none';
                pdfCounter.style.display = 'none';
                processAllBtn.style.display = 'none';
                clearPdfsBtn.style.display = 'none';
                return;
            }

            pdfList.style.display = 'block';
            pdfCounter.style.display = 'inline-block';
            processAllBtn.style.display = 'inline-block';
            clearPdfsBtn.style.display = 'inline-block';
            
            pdfCount.textContent = uploadedPDFs.length;

            let html = '';
            uploadedPDFs.forEach((pdf, index) => {
                let statusClass = '';
                let statusText = '';
                
                switch (pdf.status) {
                    case 'pending':
                        statusClass = 'pending';
                        statusText = 'Pendente';
                        break;
                    case 'processing':
                        statusClass = 'processing';
                        statusText = 'Processando...';
                        break;
                    case 'completed':
                        statusClass = 'completed';
                        statusText = 'ConcluÃ­do';
                        break;
                    case 'error':
                        statusClass = 'error';
                        statusText = 'Erro';
                        break;
                }

                html += `
                    <div class="pdf-item">
                        <div class="pdf-info">
                            <div class="pdf-icon">ð</div>
                            <div class="pdf-details">
                                <div class="pdf-name">${pdf.name}</div>
                                <div class="pdf-size">${pdf.size}</div>
                            </div>
                        </div>
                        <div class="pdf-status ${statusClass}">${statusText}</div>
                        <button class="remove-pdf" onclick="removePDF(${pdf.id})" ${pdf.status === 'processing' ? 'disabled' : ''}>
                            Ã
                        </button>
                    </div>
                `;
            });

            pdfList.innerHTML = html;
        }

        function removePDF(pdfId) {
            uploadedPDFs = uploadedPDFs.filter(pdf => pdf.id !== pdfId);
            updatePDFList();
        }

        function clearAllPDFs() {
            if (confirm('Tem certeza que deseja remover todos os PDFs da lista?')) {
                uploadedPDFs = [];
                updatePDFList();
            }
        }

        async function processAllPDFs() {
            if (uploadedPDFs.length === 0) {
                alert('Adicione pelo menos um PDF para processar!');
                return;
            }

            progressArea.style.display = 'block';
            processAllBtn.disabled = true;
            clearPdfsBtn.disabled = true;

            const totalPDFs = uploadedPDFs.length;
            let processedPDFs = 0;
            const allExtractedData = [];

            for (let i = 0; i < uploadedPDFs.length; i++) {
                const pdf = uploadedPDFs[i];
                
                try {
                    // Atualizar status para processando
                    pdf.status = 'processing';
                    updatePDFList();

                    updateProgress(
                        (processedPDFs / totalPDFs) * 100,
                        `Processando PDF ${processedPDFs + 1} de ${totalPDFs}: ${pdf.name}`
                    );

                    const extractedData = await processSinglePDF(pdf.file, i + 1, totalPDFs);
                    
                    if (extractedData && Object.keys(extractedData).length > 0) {
                        allExtractedData.push(extractedData);
                        pdf.status = 'completed';
                    } else {
                        pdf.status = 'error';
                    }

                } catch (error) {
                    console.error(`Erro ao processar PDF ${pdf.name}:`, error);
                    pdf.status = 'error';
                }

                processedPDFs++;
                updatePDFList();
            }

            // Consolidar todos os dados
            if (allExtractedData.length > 0) {
                const consolidatedData = consolidateExtractedData(allExtractedData);
                convertToResults(consolidatedData);

                updateProgress(100, 'Processamento concluÃ­do!');
                
                setTimeout(() => {
                    progressArea.style.display = 'none';
                    
                    if (currentResults.length > 0) {
                        const abnormalResults = currentResults.filter(r => 
                            r.status === 'high' || r.status === 'low' || r.status === 'positive'
                        );
                        displayResults(currentResults, abnormalResults);
                        alert(`Processamento concluÃ­do! ${currentResults.length} exames encontrados em ${allExtractedData.length} PDFs.`);
                    } else {
                        alert('Nenhum exame foi encontrado nos PDFs processados.');
                    }
                    
                    processAllBtn.disabled = false;
                    clearPdfsBtn.disabled = false;
                }, 1000);

            } else {
                updateProgress(0, 'Erro no processamento');
                setTimeout(() => {
                    progressArea.style.display = 'none';
                    processAllBtn.disabled = false;
                    clearPdfsBtn.disabled = false;
                }, 3000);
                alert('Nenhum exame foi encontrado em nenhum dos PDFs.');
            }
        }

        function consolidateExtractedData(dataArray) {
            const consolidated = {};
            
            dataArray.forEach((data, index) => {
                Object.keys(data).forEach(key => {
                    if (key === 'patientName' || key === 'examDate' || key === 'laboratory') {
                        // Para dados do paciente, usar o primeiro valor encontrado
                        if (!consolidated[key] && data[key]) {
                            consolidated[key] = data[key];
                        }
                    } else {
                        // Para exames, usar o valor mais recente ou criar uma lista
                        if (data[key] !== undefined && data[key] !== null) {
                            consolidated[key] = data[key];
                        }
                    }
                });
            });

            return consolidated;
        }

        async function processSinglePDF(file, current, total) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                const totalPages = pdf.numPages;
                
                for (let i = 1; i <= totalPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                    
                    const progress = ((current - 1) / total) * 100 + (i / totalPages) * (100 / total);
                    updateProgress(progress, `Processando PDF ${current}/${total}: pÃ¡gina ${i}/${totalPages}`);
                }

                return extractExamData(fullText);

            } catch (error) {
                console.error('Erro ao processar PDF:', error);
                throw error;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // PadrÃµes atualizados para extrair dados dos exames baseados nas referÃªncias mÃ©dicas
        const examPatterns = {
            // SorolÃ³gicos
            hiv: /HIV.*?(?:negativo|positivo|reagente|nÃ£o reagente|nÃ£o)/i,
            hepatitec: /(?:hepatite\s*c|hep\s*c).*?(?:negativo|positivo|reagente|nÃ£o reagente|nÃ£o)/i,
            htlv: /HTLV.*?(?:negativo|positivo|reagente|nÃ£o reagente|nÃ£o)/i,
            aghbs: /AgHBs.*?(?:negativo|positivo|reagente|nÃ£o reagente|nÃ£o)/i,
            vdrl: /VDRL.*?(?:negativo|positivo|reagente|nÃ£o reagente|nÃ£o)/i,
            
            // Hemograma
            hematocrito: /(?:hematÃ³crito|ht)[\s\S]*?(\d+(?:[.,]\d+)?)\s*%/i,
            hemoglobina: /(?:hemoglobina|hb)[\s\S]*?(\d+(?:[.,]\d+)?)\s*g\/dl/i,
            plaquetas: /plaquetas[\s\S]*?(\d+(?:[.,]\d+)?)/i,
            leucocitos: /(?:leucÃ³citos|leuco)[\s\S]*?(\d+(?:[.,]\d+)?)/i,
            ureia: /ureia[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            creatinina: /creatinina[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            
            // CoagulaÃ§Ã£o
            protrombina: /(?:protrombina|atividade.*protrombina)[\s\S]*?(\d+(?:[.,]\d+)?)\s*%/i,
            inr: /(?:inr|rni)[\s\S]*?(\d+(?:[.,]\d+)?)/i,
            tromboplastina: /(?:tromboplastina|ttpa)[\s\S]*?(\d+(?:[.,]\d+)?)/i,
            
            // Enzimas HepÃ¡ticas
            tgo: /(?:tgo|ast)[\s\S]*?(\d+(?:[.,]\d+)?)\s*u\/l/i,
            tgp: /(?:tgp|alt)[\s\S]*?(\d+(?:[.,]\d+)?)\s*u\/l/i,
            
            // FunÃ§Ã£o Tireoidiana
            tsh: /tsh[\s\S]*?(\d+(?:[.,]\d+)?)\s*(?:Î¼ui\/ml|uiu\/ml|miu\/ml)/i,
            t4livre: /(?:t4\s*livre|tiroxina\s*livre)[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/dl/i,
            
            // Vitaminas e HormÃ´nios
            vitaminad: /vitamina\s*d[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/ml/i,
            dht: /dht[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/dl/i,
            testosteronatotal: /(?:testosterona\s*total|test\s*total)[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/dl/i,
            testosteronalivre: /(?:testosterona\s*livre|test\s*livre)[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/dl/i,
            shbg: /shbg[\s\S]*?(\d+(?:[.,]\d+)?)\s*nmol\/l/i,
            vitaminab12: /(?:vitamina\s*b12|b12)[\s\S]*?(\d+(?:[.,]\d+)?)\s*pg\/ml/i,
            calcio: /cÃ¡lcio[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            pth: /pth[\s\S]*?(\d+(?:[.,]\d+)?)\s*pg\/ml/i,
            
            // LipoproteÃ­nas
            apolipoproteina_a1: /apolipoproteÃ­na\s*a1[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            apolipoproteina_b: /apolipoproteÃ­na\s*b[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            lipoproteina_a: /lipoproteÃ­na[\s\S]*?(\d+(?:[.,]\d+)?)\s*(?:mg\/dl|nmol\/l)/i,
            
            // Perfil LipÃ­dico
            colesterol: /colesterol\s*total[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            hdl: /(?:hdl|colesterol\s*hdl)[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            triglicerides: /triglicÃ©rides[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            
            // Outros Marcadores
            ferritina: /ferritina[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/ml/i,
            cortisol: /cortisol\s*basal[\s\S]*?(\d+(?:[.,]\d+)?)\s*Î¼g\/dl/i,
            estradiol: /estradiol[\s\S]*?(\d+(?:[.,]\d+)?)\s*pg\/ml/i,
            fibrinogenio: /fibrinogÃªnio[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            glicemia: /(?:glicemia|glicose).*?jejum[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/dl/i,
            fsh: /fsh[\s\S]*?(\d+(?:[.,]\d+)?)\s*mui\/ml/i,
            lh: /lh[\s\S]*?(\d+(?:[.,]\d+)?)\s*mui\/ml/i,
            hemoglobina_glicada: /hemoglobina\s*glicada[\s\S]*?(\d+(?:[.,]\d+)?)\s*%/i,
            insulina: /insulina[\s\S]*?(\d+(?:[.,]\d+)?)\s*Î¼ui\/ml/i,
            pcr: /pcr[\s\S]*?(\d+(?:[.,]\d+)?)\s*mg\/l/i,
            psa_total: /psa\s*total[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/ml/i,
            psa_livre: /psa\s*livre[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/ml/i,
            prolactina: /prolactina[\s\S]*?(\d+(?:[.,]\d+)?)\s*ng\/ml/i,
            vhs: /vhs[\s\S]*?(\d+(?:[.,]\d+)?)\s*mm\/h/i,
            dhea: /dhea[\s\S]*?(\d+(?:[.,]\d+)?)\s*Î¼g\/dl/i
        };

        // Valores de referÃªncia baseados no PDF mÃ©dico fornecido
        const referenceValues = {
            // SorolÃ³gicos - Resultado esperado: Negativo
            hiv: { expected: 'negativo', unit: '' },
            hepatitec: { expected: 'negativo', unit: '' },
            htlv: { expected: 'negativo', unit: '' },
            aghbs: { expected: 'negativo', unit: '' },
            vdrl: { expected: 'negativo', unit: '' },
            
            // Hemograma
            hematocrito: { min: 40, max: 53, unit: '%' },
            hemoglobina: { min: 13, max: 18, unit: 'g/dL' },
            plaquetas: { min: 150, max: 300, unit: '', alternatives: { min: 150000, max: 300000, unit: '/Î¼L' } },
            leucocitos: { min: 4.0, max: 10, unit: '', alternatives: { min: 4000, max: 10000, unit: '/Î¼L' } },
            ureia: { min: 16, max: 48, unit: 'mg/dL' },
            creatinina: { min: 0.7, max: 1.2, unit: 'mg/dL' },
            
            // CoagulaÃ§Ã£o
            protrombina: { min: 70, max: 120, unit: '%' },
            inr: { min: 0.8, max: 1.2, unit: '' },
            
            // Enzimas HepÃ¡ticas
            tgo: { max: 50, unit: 'U/L' },
            tgp: { max: 50, unit: 'U/L' },
            
            // FunÃ§Ã£o Tireoidiana
            tsh: { min: 0.4, max: 4.5, unit: 'Î¼UI/mL' },
            t4livre: { min: 0.7, max: 1.8, unit: 'ng/dL' },
            
            // Vitaminas e HormÃ´nios
            vitaminad: { min: 50, max: 100, unit: 'ng/mL' },
            dht: { min: 60, max: 300, unit: 'ng/dL' },
            testosteronatotal: { min: 400, max: 900, unit: 'ng/dL' },
            testosteronalivre: { min: 3, max: 25, unit: 'ng/dL' },
            shbg: { min: 10, max: 35, unit: 'nmol/L' },
            vitaminab12: { min: 400, max: 900, unit: 'pg/mL' },
            calcio: { min: 8.5, max: 10.5, unit: 'mg/dL' },
            pth: { min: 10, max: 40, unit: 'pg/mL' },
            
            // LipoproteÃ­nas
            apolipoproteina_a1: { min: 100, max: 214, unit: 'mg/dL' },
            apolipoproteina_b: { max: 100, unit: 'mg/dL' },
            lipoproteina_a: { max: 30, unit: 'mg/dL' },
            
            // Perfil LipÃ­dico
            colesterol: { max: 250, unit: 'mg/dL' },
            hdl: { min: 60, unit: 'mg/dL' },
            triglicerides: { max: 150, unit: 'mg/dL' },
            
            // Outros Marcadores
            ferritina: { min: 50, max: 100, unit: 'ng/mL' },
            cortisol: { min: 5, max: 25, unit: 'Î¼g/dL' },
            estradiol: { min: 11, max: 44, unit: 'pg/mL' },
            fibrinogenio: { min: 200, max: 400, unit: 'mg/dL' },
            glicemia: { min: 70, max: 99, unit: 'mg/dL' },
            fsh: { max: 10, unit: 'mUI/mL' },
            lh: { min: 0.5, max: 12, unit: 'mUI/mL' },
            hemoglobina_glicada: { max: 5.6, unit: '%' },
            insulina: { min: 2, max: 25, unit: 'Î¼UI/mL' },
            pcr: { min: 0.3, max: 1, unit: 'mg/L' },
            psa_total: { max: 3.5, unit: 'ng/mL' },
            psa_livre: { note: 'Sem valor normal - apenas registrar', unit: 'ng/mL' },
            prolactina: { max: 20, unit: 'ng/mL' },
            vhs: { max: 20, unit: 'mm/h' },
            dhea_homem: { min: 400, max: 600, unit: 'Î¼g/dL' },
            dhea_mulher: { min: 200, max: 350, unit: 'Î¼g/dL' }
        };

        function extractExamData(text) {
            const extractedData = {};
            
            // Normalizar texto
            const normalizedText = text.toLowerCase()
                .replace(/\s+/g, ' ')
                .replace(/,/g, '.');

            // Extrair dados do paciente
            const nameMatch = text.match(/nome:\s*([A-Za-z\s]+)/i);
            if (nameMatch) {
                extractedData.patientName = nameMatch[1].trim();
            }

            const dateMatch = text.match(/(?:data|coleta).*?(\d{2}\/\d{2}\/\d{4})/i);
            if (dateMatch) {
                const dateParts = dateMatch[1].split('/');
                extractedData.examDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
            }

            // Extrair valores dos exames
            for (const [examId, pattern] of Object.entries(examPatterns)) {
                const match = normalizedText.match(pattern);
                if (match) {
                    if (examId === 'hiv' || examId === 'hepatitec' || examId === 'htlv' || examId === 'aghbs' || examId === 'vdrl') {
                        // Exames sorolÃ³gicos
                        const result = match[0].toLowerCase();
                        if (result.includes('negativo') || result.includes('nÃ£o reagente')) {
                            extractedData[examId] = 'negativo';
                        } else if (result.includes('positivo') || result.includes('reagente')) {
                            extractedData[examId] = 'positivo';
                        }
                    } else {
                        // Exames numÃ©ricos
                        const value = match[1] ? match[1].replace(',', '.') : null;
                        if (value) {
                            extractedData[examId] = parseFloat(value);
                        }
                    }
                }
            }

            return extractedData;
        }

        function convertToResults(extractedData) {
            currentResults = [];
            
            // Preencher dados do paciente se encontrados
            if (extractedData.patientName) {
                document.getElementById('patientName').value = extractedData.patientName;
            }
            if (extractedData.examDate) {
                document.getElementById('examDate').value = extractedData.examDate;
            }

            // Data padrÃ£o para os exames (usar a data do exame ou a data atual)
            const defaultExamDate = extractedData.examDate ? 
                new Date(extractedData.examDate).toLocaleDateString('pt-BR') :
                new Date().toLocaleDateString('pt-BR');

            // Converter cada exame encontrado
            for (const [examId, value] of Object.entries(extractedData)) {
                if (examId !== 'patientName' && examId !== 'examDate' && value !== undefined && value !== null) {
                    const examName = getExamDisplayName(examId);
                    const reference = getReferenceText(examId);
                    const status = evaluateExamStatus(examId, value);
                    
                    currentResults.push({
                        name: examName,
                        value: formatValue(examId, value),
                        reference: reference,
                        examDate: defaultExamDate,
                        status: status
                    });
                }
            }
        }

        function getExamDisplayName(examId) {
            const names = {
                // SorolÃ³gicos
                hiv: 'HIV',
                hepatitec: 'HEP C',
                htlv: 'HTLV',
                aghbs: 'AGHBS',
                vdrl: 'VDRL',
                
                // Hemograma
                hematocrito: 'HT',
                hemoglobina: 'HB',
                plaquetas: 'PLAQ',
                leucocitos: 'LEUCO',
                ureia: 'UREIA',
                creatinina: 'CREAT',
                
                // CoagulaÃ§Ã£o
                protrombina: 'T DE PROT',
                inr: 'INR',
                tromboplastina: 'T DE TROMB',
                
                // Enzimas
                tgo: 'TGO',
                tgp: 'TGP',
                
                // Tireoide
                tsh: 'TSH',
                t4livre: 'T4 LIVRE',
                
                // Vitaminas e HormÃ´nios
                vitaminad: 'VIT D',
                dht: 'DHT',
                testosteronatotal: 'TEST TOTAL',
                testosteronalivre: 'TEST LIVRE',
                shbg: 'SHBG',
                vitaminab12: 'B12',
                calcio: 'CÃ¡lcio',
                pth: 'PTH',
                
                // LipoproteÃ­nas
                apolipoproteina_a1: 'APOLIPOPROTEÃNA A1',
                apolipoproteina_b: 'APOLIPOPROTEÃNA B',
                lipoproteina_a: 'LIPOPROTEÃNA A',
                
                // Perfil LipÃ­dico
                colesterol: 'COLESTEROL TOTAL',
                hdl: 'HDL',
                triglicerides: 'TRIGLICÃRIDES',
                
                // Outros
                ferritina: 'FERRITINA',
                cortisol: 'CORTISOL BASAL',
                estradiol: 'ESTRADIOL',
                fibrinogenio: 'FIBRINOGÃNIO',
                glicemia: 'GLICEMIA JEJUM',
                fsh: 'FSH',
                lh: 'LH',
                hemoglobina_glicada: 'HEMOGLOBINA GLICADA',
                insulina: 'INSULINA',
                pcr: 'PCR',
                psa_total: 'PSA TOTAL',
                psa_livre: 'PSA LIVRE',
                prolactina: 'PROLACTINA',
                vhs: 'VHS',
                dhea: 'DHEA',
                
                // Nomes alternativos (para compatibilidade)
                hemoglobina: 'HB',
                testosterona: 'TEST TOTAL'
            };
            return names[examId] || examId.toUpperCase();
        }

        function formatValue(examId, value) {
            if (typeof value === 'string') {
                return value === 'negativo' ? 'Negativo' : 'Positivo';
            }
            
            const ref = referenceValues[examId];
            if (ref && ref.unit) {
                return `${value} ${ref.unit}`;
            }
            return value.toString();
        }

        function evaluateExamStatus(examId, value) {
            if (typeof value === 'string') {
                const ref = referenceValues[examId];
                if (ref && ref.expected) {
                    return value.toLowerCase() === ref.expected ? 'negative' : 'positive';
                }
                return value === 'negativo' ? 'negative' : 'positive';
            }
            
            const ref = referenceValues[examId];
            if (!ref) return 'normal';
            
            let numValue = parseFloat(value);
            let minVal = ref.min;
            let maxVal = ref.max;
            
            // Tratamento especial para Plaquetas e LeucÃ³citos
            if (examId === 'plaquetas') {
                // Se o valor Ã© > 1000, assumir formato completo (150.000-300.000)
                // Se o valor Ã© < 1000, assumir formato abreviado (150-300)
                if (numValue > 1000) {
                    minVal = ref.alternatives.min; // 150000
                    maxVal = ref.alternatives.max; // 300000
                } else {
                    minVal = ref.min; // 150
                    maxVal = ref.max; // 300
                }
            } else if (examId === 'leucocitos') {
                // Se o valor Ã© > 100, assumir formato completo (4.000-10.000)
                // Se o valor Ã© < 100, assumir formato abreviado (4,0-10)
                if (numValue > 100) {
                    minVal = ref.alternatives.min; // 4000
                    maxVal = ref.alternatives.max; // 10000
                } else {
                    minVal = ref.min; // 4.0
                    maxVal = ref.max; // 10
                }
            }
            
            if (minVal && maxVal) {
                if (numValue < minVal) return 'low';
                if (numValue > maxVal) return 'high';
                return 'normal';
            } else if (maxVal && !minVal) {
                return numValue > maxVal ? 'high' : 'normal';
            } else if (minVal && !maxVal) {
                return numValue < minVal ? 'low' : 'normal';
            }
            
            return 'normal';
        }

        function getReferenceText(examId) {
            const ref = referenceValues[examId];
            if (!ref) {
                // Para exames sorolÃ³gicos sem mapeamento especÃ­fico
                if (examId.includes('hiv') || examId.includes('hepatite') || examId.includes('htlv') || 
                    examId.includes('aghbs') || examId.includes('vdrl')) {
                    return 'Negativo';
                }
                return 'NÃ£o definido';
            }

            // Casos especiais
            if (ref.expected) {
                return ref.expected === 'negativo' ? 'Negativo' : 'Positivo';
            }

            if (ref.note) {
                return ref.note;
            }

            // Tratamento especial para Plaquetas e LeucÃ³citos (mostrar ambos os formatos)
            if (examId === 'plaquetas') {
                return `${ref.min}-${ref.max} ou ${ref.alternatives.min.toLocaleString()}-${ref.alternatives.max.toLocaleString()} ${ref.alternatives.unit}`;
            } else if (examId === 'leucocitos') {
                return `${ref.min}-${ref.max} ou ${ref.alternatives.min.toLocaleString()}-${ref.alternatives.max.toLocaleString()} ${ref.alternatives.unit}`;
            }

            // Valores numÃ©ricos normais
            if (ref.min && ref.max) {
                return `${ref.min} - ${ref.max} ${ref.unit}`;
            } else if (ref.max && !ref.min) {
                return `< ${ref.max} ${ref.unit}`;
            } else if (ref.min && !ref.max) {
                return `> ${ref.min} ${ref.unit}`;
            }
            
            return 'NÃ£o definido';
        }

        // FunÃ§Ãµes bÃ¡sicas
        function toggleManualInput() {
            const inputSection = document.querySelector('.input-section');
            const mainContent = document.querySelector('.main-content');
            
            if (inputSection.style.display === 'none' || inputSection.style.display === '') {
                inputSection.style.display = 'block';
                mainContent.style.gridTemplateColumns = '1fr 1fr';
            } else {
                inputSection.style.display = 'none';
                mainContent.style.gridTemplateColumns = '1fr';
            }
        }

        function addManualExam() {
            const name = document.getElementById('examNameInput').value.trim();
            const value = document.getElementById('examValueInput').value.trim();
            const reference = document.getElementById('examReferenceInput').value.trim();
            const examDate = document.getElementById('examDateInput').value;
            const status = document.getElementById('examStatusInput').value;

            if (!name || !value || !reference || !examDate) {
                alert('Preencha todos os campos, incluindo a data do exame!');
                return;
            }

            const formattedDate = new Date(examDate).toLocaleDateString('pt-BR');
            
            currentResults.push({ 
                name, 
                value, 
                reference, 
                examDate: formattedDate,
                status 
            });
            
            // Limpar campos
            clearManualForm();
            
            alert('Exame adicionado com sucesso!');
        }

        function clearManualForm() {
            document.getElementById('examNameInput').value = '';
            document.getElementById('examValueInput').value = '';
            document.getElementById('examReferenceInput').value = '';
            document.getElementById('examDateInput').value = '';
            document.getElementById('examStatusInput').value = 'normal';
        }

        function processExams() {
            if (currentResults.length === 0) {
                alert('Adicione pelo menos um exame ou processe os PDFs primeiro!');
                return;
            }

            const abnormalResults = currentResults.filter(r => 
                r.status === 'high' || r.status === 'low' || r.status === 'positive'
            );
            
            displayResults(currentResults, abnormalResults);
        }

        function displayResults(results, abnormalResults) {
            // Definir TODOS os exames mÃ©dicos padrÃ£o organizados por categoria
            const completeExamStructure = {
                'Exames': [
                    { name: 'HIV', standard: 'HIV' },
                    { name: 'HEP C', standard: 'Hepatite C' },
                    { name: 'HTLV', standard: 'HTLV' },
                    { name: 'AGHBS', standard: 'AgHBs' },
                    { name: 'VDRL', standard: 'VDRL' },
                    { name: 'ECG', standard: 'ECG' },
                    { name: 'HT', standard: 'HematÃ³crito' },
                    { name: 'HB', standard: 'Hemoglobina' },
                    { name: 'PLAQ', standard: 'Plaquetas' },
                    { name: 'LEUCO', standard: 'LeucÃ³citos' },
                    { name: 'UREIA', standard: 'Ureia' },
                    { name: 'CREAT', standard: 'Creatinina' },
                    { name: 'T DE PROT', standard: 'Tempo de Protrombina' },
                    { name: 'T DE TROMB', standard: 'Tempo de Trombina' },
                    { name: 'TGO', standard: 'TGO' },
                    { name: 'TGP', standard: 'TGP' },
                    { name: 'TSH', standard: 'TSH' },
                    { name: 'T4 LIVRE', standard: 'T4 Livre' },
                    { name: 'VIT D', standard: 'Vitamina D' },
                    { name: 'DHT', standard: 'DHT' },
                    { name: 'TEST TOTAL', standard: 'Testosterona Total' },
                    { name: 'TEST LIVRE', standard: 'Testosterona Livre' },
                    { name: 'B12', standard: 'Vitamina B12' },
                    { name: 'CÃ¡lcio', standard: 'CÃ¡lcio' },
                    { name: 'PTH', standard: 'PTH' },
                    { name: 'SHBG', standard: 'SHBG' },
                    { name: 'APOLIPOPROTEÃNA A1', standard: 'ApolipoproteÃ­na A1' },
                    { name: 'APOLIPOPROTEÃNA B', standard: 'ApolipoproteÃ­na B' },
                    { name: 'LIPOPROTEÃNA A', standard: 'LipoproteÃ­na A' },
                    { name: 'COLESTEROL TOTAL', standard: 'Colesterol Total' },
                    { name: 'HDL', standard: 'HDL' },
                    { name: 'TRIGLICÃRIDES', standard: 'TriglicÃ©rides' },
                    { name: 'FERRITINA', standard: 'Ferritina' },
                    { name: 'CORTISOL BASAL', standard: 'Cortisol Basal' },
                    { name: 'ESTRADIOL', standard: 'Estradiol' },
                    { name: 'FIBRINOGÃNIO', standard: 'FibrinogÃªnio' },
                    { name: 'GLICEMIA JEJUM', standard: 'Glicemia' },
                    { name: 'FSH', standard: 'FSH' },
                    { name: 'LH', standard: 'LH' },
                    { name: 'HEMOGLOBINA GLICADA', standard: 'Hemoglobina Glicada' },
                    { name: 'INSULINA', standard: 'Insulina' },
                    { name: 'PCR', standard: 'PCR' },
                    { name: 'PSA TOTAL', standard: 'PSA Total' },
                    { name: 'PSA LIVRE', standard: 'PSA Livre' },
                    { name: 'PROLACTINA', standard: 'Prolactina' },
                    { name: 'VHS', standard: 'VHS' },
                    { name: 'OBSERVAÃÃES', standard: 'ObservaÃ§Ãµes' }
                ]
            };

            let html = `
                <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h3 style="color: #2980b9; margin-bottom: 15px;">Resumo Geral</h3>
                    <p><strong>Total de exames processados:</strong> ${results.length}</p>
                    <p><strong>Exames alterados:</strong> ${abnormalResults.length}</p>
                    <p><strong>Status geral:</strong> ${abnormalResults.length === 0 ? 
                        '<span style="color: #27ae60;">Todos os exames processados dentro da normalidade</span>' : 
                        '<span style="color: #e74c3c;">Alguns exames alterados</span>'}</p>
                </div>
            `;
            
            if (abnormalResults.length > 0) {
                html += `
                    <div style="background: #fdf2e9; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #e67e22;">
                        <h3 style="color: #d35400; margin-bottom: 15px;">Exames com AlteraÃ§Ãµes</h3>
                        <ul style="margin-left: 20px;">
                `;
                
                abnormalResults.forEach(result => {
                    html += `<li style="margin-bottom: 8px;"><strong>${result.name}:</strong> ${result.value}</li>`;
                });
                
                html += `</ul></div>`;
            }

            // Criar tabela no formato mÃ©dico completo
            const patientName = document.getElementById('patientName')?.value || 'PACIENTE NÃO INFORMADO';
            
            html += `
                <table class="summary-table" id="resultsTable">
                    <tr>
                        <td colspan="7" class="patient-name-header">NOME PACIENTE: ${patientName}</td>
                    </tr>
            `;

            // FunÃ§Ã£o para encontrar resultado de um exame
            function findResult(standardName, displayName) {
                return results.find(r => 
                    r.name === standardName || 
                    r.name === displayName ||
                    r.name.toLowerCase().includes(standardName.toLowerCase()) ||
                    standardName.toLowerCase().includes(r.name.toLowerCase())
                );
            }

            // Processar todos os exames sem categorias
            const allExams = completeExamStructure['Exames'];
            const maxCols = 6;
            
            for (let i = 0; i < allExams.length; i += maxCols) {
                const rowExams = allExams.slice(i, i + maxCols);
                
                // Linha de nomes dos exames
                html += '<tr>';
                html += '<td style="background: #95a5a6; color: white; font-weight: bold; text-align: left; padding: 8px;">EXAMES (Data)</td>';
                
                rowExams.forEach(exam => {
                    html += `<td style="background: #95a5a6; color: white; font-weight: bold; font-size: 0.8rem;">${exam.name}</td>`;
                });
                
                // Completar com cÃ©lulas vazias
                for (let j = rowExams.length; j < maxCols; j++) {
                    html += '<td class="empty-cell"></td>';
                }
                html += '</tr>';

                // Linha de datas
                html += '<tr>';
                html += '<td class="empty-cell"></td>';
                
                rowExams.forEach(exam => {
                    const result = findResult(exam.standard, exam.name);
                    const examDate = result?.examDate || '';
                    html += `<td class="exam-date">${examDate}</td>`;
                });
                
                for (let j = rowExams.length; j < maxCols; j++) {
                    html += '<td class="empty-cell"></td>';
                }
                html += '</tr>';

                // Linha de resultados
                html += '<tr>';
                html += '<td class="empty-cell"></td>';
                
                rowExams.forEach(exam => {
                    const result = findResult(exam.standard, exam.name);
                    
                    if (result) {
                        let statusClass = '';
                        switch (result.status) {
                            case 'normal': statusClass = 'status-normal'; break;
                            case 'high': statusClass = 'status-high'; break;
                            case 'low': statusClass = 'status-low'; break;
                            case 'positive': statusClass = 'status-positive'; break;
                            case 'negative': statusClass = 'status-negative'; break;
                        }
                        
                        const globalIndex = results.findIndex(r => 
                            r.name === result.name && 
                            r.value === result.value && 
                            r.examDate === result.examDate
                        );
                        
                        html += `<td class="editable-cell ${statusClass}" onclick="openEditModal(${globalIndex})" style="cursor: pointer;">
                            <div style="font-weight: bold; font-size: 0.85rem;">${result.value}</div>
                            <div style="font-size: 0.7rem; color: #666; margin-top: 2px;">${result.reference}</div>
                        </td>`;
                    } else {
                        // CÃ©lula vazia para exames sem resultado
                        html += '<td class="empty-cell" style="border: 1px solid #bdc3c7; min-height: 40px;"></td>';
                    }
                });
                
                for (let j = rowExams.length; j < maxCols; j++) {
                    html += '<td class="empty-cell"></td>';
                }
                html += '</tr>';

                // EspaÃ§o entre grupos de exames
                if (i + maxCols < allExams.length) {
                    html += '<tr><td colspan="7" style="height: 10px; border: none;"></td></tr>';
                }
            }

            html += `</table>`;
            
            if (editMode) {
                html += `<button class="add-result-btn" onclick="openEditModal(-1)">Adicionar Novo Resultado</button>`;
            }
            
            document.getElementById('summaryResult').innerHTML = html;
            
            // Adicionar indicadores de ediÃ§Ã£o se modo ativo
            if (editMode) {
                const editableCells = document.querySelectorAll('.editable-cell');
                editableCells.forEach(cell => {
                    const indicator = document.createElement('span');
                    indicator.className = 'edit-indicator';
                    indicator.textContent = 'â';
                    indicator.style.cssText = `
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        background: #1e3c72;
                        color: white;
                        border-radius: 50%;
                        width: 16px;
                        height: 16px;
                        font-size: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                    `;
                    cell.style.position = 'relative';
                    cell.appendChild(indicator);
                });
            }
        }

        // FunÃ§Ãµes de ediÃ§Ã£o
        function showEditMode() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === '1010') {
                editMode = true;
                closePasswordModal();
                alert('Modo de ediÃ§Ã£o ativado! Clique nas cÃ©lulas da tabela para editar.');
                if (currentResults.length > 0) {
                    displayResults(currentResults, currentResults.filter(r => 
                        r.status === 'high' || r.status === 'low' || r.status === 'positive'
                    ));
                }
            } else {
                alert('Senha incorreta!');
            }
            document.getElementById('passwordInput').value = '';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function openEditModal(index) {
            if (!editMode && index !== -1) {
                alert('Ative o modo de ediÃ§Ã£o primeiro!');
                return;
            }
            
            editingIndex = index;
            const modal = document.getElementById('editModal');
            
            if (index === -1) {
                document.getElementById('editModalTitle').textContent = 'Adicionar Novo Resultado';
                document.getElementById('editExamName').value = '';
                document.getElementById('editValue').value = '';
                document.getElementById('editReference').value = '';
                document.getElementById('editExamDate').value = '';
                document.getElementById('editStatus').value = 'normal';
            } else {
                document.getElementById('editModalTitle').textContent = 'Editar Resultado';
                const result = currentResults[index];
                document.getElementById('editExamName').value = result.name;
                document.getElementById('editValue').value = result.value;
                document.getElementById('editReference').value = result.reference;
                
                // Converter data brasileira para formato ISO se necessÃ¡rio
                if (result.examDate && result.examDate !== 'NÃ£o informado') {
                    const dateParts = result.examDate.split('/');
                    if (dateParts.length === 3) {
                        const isoDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                        document.getElementById('editExamDate').value = isoDate;
                    }
                } else {
                    document.getElementById('editExamDate').value = '';
                }
                
                document.getElementById('editStatus').value = result.status;
            }
            
            modal.style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const name = document.getElementById('editExamName').value.trim();
            const value = document.getElementById('editValue').value.trim();
            const reference = document.getElementById('editReference').value.trim();
            const examDate = document.getElementById('editExamDate').value;
            const status = document.getElementById('editStatus').value;
            
            if (!name || !value || !reference || !examDate) {
                alert('Preencha todos os campos, incluindo a data do exame!');
                return;
            }
            
            // Converter data ISO para formato brasileiro
            const formattedDate = new Date(examDate).toLocaleDateString('pt-BR');
            
            const newResult = { 
                name, 
                value, 
                reference, 
                examDate: formattedDate,
                status 
            };
            
            if (editingIndex === -1) {
                currentResults.push(newResult);
            } else {
                currentResults[editingIndex] = newResult;
            }
            
            const abnormalResults = currentResults.filter(r => 
                r.status === 'high' || r.status === 'low' || r.status === 'positive'
            );
            
            displayResults(currentResults, abnormalResults);
            closeEditModal();
            alert('Salvo com sucesso!');
        }

        function deleteResult() {
            if (editingIndex === -1) {
                alert('NÃ£o Ã© possÃ­vel excluir um novo resultado!');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este resultado?')) {
                currentResults.splice(editingIndex, 1);
                
                const abnormalResults = currentResults.filter(r => 
                    r.status === 'high' || r.status === 'low' || r.status === 'positive'
                );
                
                displayResults(currentResults, abnormalResults);
                closeEditModal();
                alert('ExcluÃ­do com sucesso!');
            }
        }

        // FunÃ§Ã£o de download melhorada
        async function downloadAsImage() {
            if (currentResults.length === 0) {
                alert('Processe os exames primeiro!');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Gerando...';
            btn.disabled = true;

            try {
                // Verificar se html2canvas estÃ¡ disponÃ­vel
                if (typeof html2canvas === 'undefined') {
                    throw new Error('Biblioteca html2canvas nÃ£o carregada. Tente recarregar a pÃ¡gina.');
                }

                const summaryElement = document.getElementById('summaryResult');
                
                if (!summaryElement) {
                    throw new Error('Elemento de resumo nÃ£o encontrado.');
                }

                // Aguardar um momento para garantir que tudo estÃ¡ renderizado
                await new Promise(resolve => setTimeout(resolve, 500));

                // Criar elemento temporÃ¡rio para captura
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 900px;
                    background: white;
                    padding: 40px;
                    font-family: 'Segoe UI', Arial, sans-serif;
                    z-index: -1;
                    transform: translateX(-100%);
                `;

                const patientName = document.getElementById('patientName')?.value || 'Paciente NÃ£o Informado';
                const examDateValue = document.getElementById('examDate')?.value;
                const laboratory = document.getElementById('laboratory')?.value || 'LaboratÃ³rio NÃ£o Informado';
                
                let examDate = 'Data NÃ£o Informada';
                if (examDateValue) {
                    examDate = new Date(examDateValue + 'T00:00:00').toLocaleDateString('pt-BR');
                }

                // Header melhorado
                const header = `
                    <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #1e3c72; padding-bottom: 25px;">
                        <h1 style="color: #1e3c72; margin: 0; font-size: 28px; font-weight: bold;">RESUMO DE EXAMES LABORATORIAIS</h1>
                        <div style="margin-top: 15px; font-size: 14px; line-height: 1.6;">
                            <p style="margin: 5px 0;"><strong>Paciente:</strong> ${patientName}</p>
                            <p style="margin: 5px 0;"><strong>Data do Exame:</strong> ${examDate}</p>
                            <p style="margin: 5px 0;"><strong>LaboratÃ³rio:</strong> ${laboratory}</p>
                            <p style="margin: 5px 0;"><strong>RelatÃ³rio Gerado em:</strong> ${new Date().toLocaleDateString('pt-BR')} Ã s ${new Date().toLocaleTimeString('pt-BR')}</p>
                        </div>
                    </div>
                `;

                // Clonar e limpar conteÃºdo
                const clone = summaryElement.cloneNode(true);
                
                // Remover elementos de ediÃ§Ã£o
                const indicators = clone.querySelectorAll('.edit-indicator');
                indicators.forEach(el => el.remove());
                const buttons = clone.querySelectorAll('button');
                buttons.forEach(el => el.remove());
                
                // Aplicar estilos inline para garantir renderizaÃ§Ã£o
                const tables = clone.querySelectorAll('table');
                tables.forEach(table => {
                    table.style.cssText = `
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                        font-family: 'Segoe UI', Arial, sans-serif;
                        border: 1px solid #ddd;
                    `;
                });

                const ths = clone.querySelectorAll('th');
                ths.forEach(th => {
                    th.style.cssText = `
                        background: #1e3c72;
                        color: white;
                        padding: 15px 10px;
                        text-align: left;
                        font-weight: bold;
                        border: 1px solid #ddd;
                        font-size: 14px;
                    `;
                });

                const tds = clone.querySelectorAll('td');
                tds.forEach(td => {
                    td.style.cssText = `
                        padding: 12px 10px;
                        border: 1px solid #ddd;
                        font-size: 13px;
                        line-height: 1.4;
                    `;
                    
                    // Manter cores de status
                    if (td.closest('tr').classList.contains('status-high')) {
                        td.style.backgroundColor = '#fee2e2';
                        td.style.color = '#991b1b';
                    } else if (td.closest('tr').classList.contains('status-low')) {
                        td.style.backgroundColor = '#fefce8';
                        td.style.color = '#854d0e';
                    } else if (td.closest('tr').classList.contains('status-positive')) {
                        td.style.backgroundColor = '#fee2e2';
                        td.style.color = '#991b1b';
                    } else if (td.closest('tr').classList.contains('status-negative')) {
                        td.style.backgroundColor = '#dcfce7';
                        td.style.color = '#166534';
                    } else if (td.closest('tr').classList.contains('status-normal')) {
                        td.style.backgroundColor = '#dcfce7';
                        td.style.color = '#166534';
                    }
                });

                tempDiv.innerHTML = header + clone.innerHTML;
                document.body.appendChild(tempDiv);

                console.log('Iniciando captura...');

                // Capturar com configuraÃ§Ãµes otimizadas
                const canvas = await html2canvas(tempDiv, {
                    backgroundColor: '#ffffff',
                    scale: 1.5,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: 900,
                    height: tempDiv.offsetHeight,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: 900,
                    windowHeight: tempDiv.offsetHeight
                });

                // Remover elemento temporÃ¡rio
                document.body.removeChild(tempDiv);

                console.log('Captura concluÃ­da, iniciando download...');

                // Criar e fazer download
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 16).replace('T', '_').replace(':', '-');
                link.download = `Resumo_Exames_${timestamp}.png`;
                
                // Converter para blob para melhor compatibilidade
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    
                    // ForÃ§ar download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Limpar URL
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    
                    alert('â Imagem baixada com sucesso!');
                }, 'image/png', 0.95);

            } catch (error) {
                console.error('Erro detalhado:', error);
                
                // Mensagens de erro mais especÃ­ficas
                let errorMessage = 'Erro ao gerar imagem: ';
                if (error.message.includes('html2canvas')) {
                    errorMessage += 'Problema com a biblioteca de captura. Tente recarregar a pÃ¡gina.';
                } else if (error.message.includes('nÃ£o encontrado')) {
                    errorMessage += 'Dados nÃ£o encontrados. Processe alguns exames primeiro.';
                } else {
                    errorMessage += error.message || 'Erro desconhecido. Tente novamente.';
                }
                
                alert(errorMessage);
                
                // Tentar mÃ©todo alternativo simples
                if (confirm('Deseja tentar um mÃ©todo alternativo de download?')) {
                    try {
                        await downloadAlternativeMethod();
                    } catch (altError) {
                        alert('MÃ©todo alternativo tambÃ©m falhou. Tente usar outro navegador (Chrome ou Firefox recomendados).');
                    }
                }
            }

            btn.textContent = originalText;
            btn.disabled = false;
        }

        // MÃ©todo alternativo de download
        async function downloadAlternativeMethod() {
            const summaryElement = document.getElementById('summaryResult');
            const patientName = document.getElementById('patientName')?.value || 'Paciente';
            
            // Criar HTML simples para download
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Resumo de Exames</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #1e3c72; color: white; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e3c72; padding-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>RESUMO DE EXAMES LABORATORIAIS</h1>
                        <p><strong>Paciente:</strong> ${patientName}</p>
                        <p><strong>Gerado:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                    </div>
                    ${summaryElement.innerHTML.replace(/<button[^>]*>.*?<\/button>/gi, '')}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Resumo_Exames_${new Date().toISOString().slice(0, 10)}.html`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('ð Arquivo HTML baixado! VocÃª pode abri-lo no navegador e usar "Imprimir para PDF" ou capturar tela.');
        }

        function savePatientData() {
            const name = document.getElementById('patientName').value.trim();
            const date = document.getElementById('examDate').value;
            const lab = document.getElementById('laboratory').value.trim();
            
            if (!name || !date) {
                alert('Preencha pelo menos o nome do paciente e a data do exame!');
                return;
            }
            
            alert('Dados do paciente salvos com sucesso!');
        }

        // NOVAS FUNÃÃES DE LIMPEZA COMPLETA
        function confirmClearAll() {
            document.getElementById('confirmClearModal').style.display = 'flex';
        }

        function closeClearModal() {
            document.getElementById('confirmClearModal').style.display = 'none';
        }

        function executeCompleteReset() {
            // Reset de todas as variÃ¡veis globais
            currentResults = [];
            editMode = false;
            editingIndex = -1;
            uploadedPDFs = [];

            // Limpar todos os campos de dados do paciente
            document.getElementById('patientName').value = '';
            document.getElementById('examDate').value = '';
            document.getElementById('laboratory').value = '';

            // Limpar formulÃ¡rio manual
            clearManualForm();

            // Resetar Ã¡rea de upload
            document.getElementById('pdfFile').value = '';
            progressArea.style.display = 'none';
            progressFill.style.width = '0%';
            progressText.textContent = '';
            uploadArea.classList.remove('dragover');

            // Atualizar lista de PDFs
            updatePDFList();

            // Resetar Ã¡rea de resultados
            document.getElementById('summaryResult').innerHTML = `
                <p style="text-align: center; color: #666; margin-top: 50px;">
                    Adicione PDFs ou preencha os dados dos exames manualmente e clique em "Processar" para ver o resultado.
                </p>
            `;

            // Esconder seÃ§Ã£o manual se estiver visÃ­vel
            const inputSection = document.querySelector('.input-section');
            const mainContent = document.querySelector('.main-content');
            if (inputSection.style.display === 'block') {
                inputSection.style.display = 'none';
                mainContent.style.gridTemplateColumns = '1fr';
            }

            // Fechar todos os modals
            closePasswordModal();
            closeEditModal();
            closeClearModal();

            // Resetar data para hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('examDate').value = today;
            document.getElementById('examDateInput').value = today;

            // Confirmar reset
            alert('â Sistema resetado com sucesso! Todos os dados foram apagados.');
            
            console.log('Sistema completamente resetado');
        }

        // Definir data atual como padrÃ£o ao carregar a pÃ¡gina
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('examDate').value = today;
            document.getElementById('examDateInput').value = today;
        });
    </script>
</body>
</html>